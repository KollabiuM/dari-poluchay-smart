# üìã –û—Ç—á–µ—Ç –æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –ø—Ä–æ–µ–∫—Ç–∞ "–î–∞—Ä–∏ –ü–æ–ª—É—á–∞–π Smart"

**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–µ–∫—Ç –≤ —Ü–µ–ª–æ–º –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

---

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç Service Layer pattern
2. **–ò–º–ø–æ—Ä—Ç—ã** ‚Äî –≤—Å–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –Ω–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
3. **–°—Ç–∏–ª—å –∫–æ–¥–∞** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º –∏–∑ `.cursorrules`
4. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Python 3.10+ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (`|` –≤–º–µ—Å—Ç–æ `Union`)
5. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** ‚Äî –≤—Å–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ async
6. **–ú–æ–¥–µ–ª–∏ –ë–î** ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å `__table_args__ = {"extend_existing": True}`
7. **–õ–∏–Ω—Ç–µ—Ä** ‚Äî –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

---

## ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è `alert()` (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ø—Ä–∞–≤–∏–ª–∞—Ö —Å—Ç–∏–ª—è (`.cursorrules`) —É–∫–∞–∑–∞–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `alert()` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:** –£–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# utils/send_message_utils.py
from bot_instance import bot
from config import LOGCHAT

async def alert(text: str) -> None:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –ª–æ–≥–æ–≤."""
    try:
        if LOGCHAT:
            await bot.send_message(chat_id=LOGCHAT, text=text)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ LOGCHAT: {e}")
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í—ã—Å–æ–∫–∏–π (–Ω—É–∂–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫)

---

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ `_find_receiver_table` (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `handlers/admin.py:147` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ —Å–µ—Ä–≤–∏—Å–∞.

**–ö–æ–¥:**
```python
# handlers/admin.py:147
existing = await table_service._find_receiver_table(creator_tid, level)
```

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –≤ `TableService`:
```python
# services/table_service.py
async def find_receiver_table(self, receiver_tid: int, level: int) -> Optional[Table]:
    """–ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É—é –¥–æ—Å–∫—É –≥–¥–µ tid ‚Äî –ø–æ–ª—É—á–∞—Ç–µ–ª—å (Receiver)."""
    return await self._find_receiver_table(receiver_tid, level)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏–∏)

---

### 3. –§—É–Ω–∫—Ü–∏—è `parse_level` –≤ handlers (–ù–ò–ó–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Ç–∏–ª–∏—Ç–∞ `parse_level` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ `handlers/boards.py`, –Ω–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ `utils/`.

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ `utils/level_utils.py`:
```python
# utils/level_utils.py
from typing import Optional
from models.table import LEVELS

def parse_level(arg: str) -> Optional[int]:
    """–ü–∞—Ä—Å–∏—Ç —É—Ä–æ–≤–µ–Ω—å –∏–∑ —Å—Ç—Ä–æ–∫–∏."""
    if arg.isdigit():
        level = int(arg)
        if 1 <= level <= 13:
            return level
        return None
    
    arg_lower = arg.lower()
    for level_num, info in LEVELS.items():
        if info["name"].lower() == arg_lower:
            return level_num
    
    return None
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π (—Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–∞—Ä—É—à–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É)

---

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Å–µ—Ä–≤–∏—Å–∞—Ö –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ `IntegrityError` –ø—Ä–∏ –∫–æ–º–º–∏—Ç–∞—Ö.

**–ü—Ä–∏–º–µ—Ä:**
```python
# services/user_service.py:105
await self.session.commit()  # –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç–µ reflink
```

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å try/except –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö:
```python
from sqlalchemy.exc import IntegrityError

try:
    await self.session.commit()
except IntegrityError as e:
    await self.session.rollback()
    # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ alert()
    raise e
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π (–º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö)

---

### 5. –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω—è –≤ `create_table` (–ù–ò–ó–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `TableService.create_table()` –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ `level` –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 1-13.

**–†–µ—à–µ–Ω–∏–µ:**
```python
async def create_table(self, level: int, ...) -> Table:
    if level not in LEVELS:
        raise ValueError(f"Invalid level: {level}. Must be 1-13")
    # ...
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫)

---

### 6. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback `split_board` (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `keyboards/board_keyboards.py:145` –µ—Å—Ç—å callback `split_board:{table.id}:left`, –Ω–æ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ `handlers/boards.py`.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
```python
@router.callback_query(F.data.startswith("split_board:"))
async def callback_split_board(callback: CallbackQuery) -> None:
    """–†–∞–∑–¥–µ–ª–∏—Ç—å –¥–æ—Å–∫—É."""
    # –ü–∞—Ä—Å–∏–º table_id –∏ side
    # –í—ã–∑—ã–≤–∞–µ–º table_service.split_table()
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

---

### 7. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–æ—à–µ–ª—å–∫–∞ (–ù–ò–ó–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞ (`connect_wallet`), –Ω–æ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ Python:** ~15
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~2500
- **–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º:** 1
- **–°—Ä–µ–¥–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 3
- **–ù–∏–∑–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 3

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

1. **–°—Ä–æ—á–Ω–æ:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `alert()` —Ñ—É–Ω–∫—Ü–∏—é
2. **–í–∞–∂–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `split_board`
3. **–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
4. **–ú–æ–∂–Ω–æ –ø–æ–∑–∂–µ:** –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —É—Ç–∏–ª–∏—Ç –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –Ω–∞–ø–∏—Å–∞–Ω –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º —Å—Ç–∏–ª—è. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è `alert()`
- –ù–µ–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** üü¢ 8/10 ‚Äî –ø—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
